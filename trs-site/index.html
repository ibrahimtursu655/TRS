<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>TRS ‚Äî G√ºvenli Gelecek</title>
  <link rel="icon" type="image/png" href="images/favicon.png">

  <style>
    :root{--bg:#0a0a0a;--text:#e7e7e7;--muted:#a9a9a9;--gold:#d4af37;--accent:#00d8ff;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.45)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:Poppins,sans-serif;line-height:1.6;overflow-x:hidden}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{position:sticky;top:0;background:rgba(10,10,10,.55);border-bottom:1px solid rgba(255,255,255,.06);z-index:1000}
    .nav{display:flex;align-items:center;justify-content:space-between;height:78px}
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--text)}
    .brand img{height:48px;border-radius:8px}
    nav a{color:var(--text);text-decoration:none;margin:0 12px;font-weight:600;position:relative;opacity:.9;padding:6px 2px}
    nav a:hover{opacity:1}
    nav a:after{content:"";position:absolute;left:0;bottom:-6px;height:2px;width:0;background:linear-gradient(90deg,var(--gold),var(--accent));transition:width .25s}
    nav a:hover:after{width:100%}
    .cta{display:inline-flex;align-items:center;gap:10px;padding:10px 18px;border-radius:999px;text-decoration:none;background:linear-gradient(135deg,var(--gold),#b58913);color:#111;font-weight:800;box-shadow:var(--shadow);border:1px solid rgba(255,255,255,.15)}

    /* Yorumlar */
    .comment-section{padding:70px 0;border-top:1px solid rgba(255,255,255,0.1)}
    .comment-section h2{text-align:center;color:var(--gold);margin-bottom:20px}
    .comment-form{display:flex;flex-direction:column;gap:10px;max-width:600px;margin:0 auto}
    .comment-form input,.comment-form textarea,.comment-form select{padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.08);color:#fff}
    .comment-form button{align-self:flex-end;padding:10px 18px;border-radius:10px}
    .comment-controls{max-width:800px;margin:20px auto;text-align:right}
    .comment-controls select{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.08);color:#fff;border:none;}
    .comment-list{max-width:800px;margin:20px auto 0;display:grid;gap:12px}
    .comment-item{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;position:relative}
    .comment-item .meta{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .comment-item .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--accent));display:flex;align-items:center;justify-content:center;color:#111;font-weight:700}
    .comment-item .name{font-weight:700;color:var(--gold)}
    .comment-item .rating{color:var(--accent)}
    .comment-item p{margin-top:6px;color:var(--text);line-height:1.4}
    .comment-item .delete-btn{position:absolute;top:8px;right:8px;padding:4px 8px;border:none;border-radius:6px;background:rgba(255,0,0,0.6);color:#fff;cursor:pointer;font-size:0.8rem}

    .pagination{max-width:800px;margin:30px auto 0;text-align:center}
    .pagination button{margin:0 5px;padding:8px 14px;border:none;border-radius:8px;background:rgba(255,255,255,0.08);color:#fff;cursor:pointer}
    .pagination button.active{background:var(--gold);color:#111;font-weight:700}

    /* Bildirim modal */
    .notify-overlay{display:none;position:fixed;inset:0;backdrop-filter:blur(6px);background:rgba(0,0,0,0.45);z-index:3000;align-items:center;justify-content:center}
    .notify{background:#0f0f0f;padding:28px;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.6);text-align:center;color:#fff;max-width:420px;position:relative}
    .notify .close{position:absolute;right:12px;top:10px;color:#fff;font-size:20px;cursor:pointer}
    .notify .icon-wrap{width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;position:relative}
    .notify.success .icon-wrap{background:conic-gradient(from 0deg, rgba(0,200,0,.15) 0, transparent 0);border:4px solid rgba(0,200,0,0.12)}
    .notify.success .icon{width:60px;height:60px;border-radius:50%;background:#0f0;padding:10px;display:flex;align-items:center;justify-content:center;color:#063}
    .notify.error .icon-wrap{background:conic-gradient(from 0deg, rgba(255,0,0,.12) 0, transparent 0);border:4px solid rgba(255,0,0,0.12)}
    .notify.error .icon{width:60px;height:60px;border-radius:50%;background:#f00;padding:10px;display:flex;align-items:center;justify-content:center;color:#fff}
    .ring { position:absolute; inset: -12px; border-radius:50%; border:3px solid rgba(255,255,255,0.06); animation:spin 1.2s linear; }
    @keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }
    .notify .text{margin-top:8px;color:#fff}
    .notify .reason{margin-top:10px;color:#ffd6d6;font-size:0.95rem}

    /* Silme onay modal */
    .confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:4000;align-items:center;justify-content:center}
    .confirm-box{background:#111;padding:24px;border-radius:12px;max-width:400px;text-align:center;color:#fff}
    .confirm-box h3{margin-bottom:20px;color:var(--gold)}
    .confirm-box button{margin:0 10px;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    .confirm-box .accept{background:var(--gold);color:#111}
    .confirm-box .cancel{background:rgba(255,255,255,0.08);color:#fff}
  </style>
</head>
<body>

<!-- K√º√ß√ºk ama √∂nemli: sayfa y√ºklenince URL hash varsa temizle, ilk g√∂r√ºn√ºm hero olsun -->
<script>
  // Eƒüer kullanƒ±cƒ± siteyi #yorumlar gibi bir hash ile a√ßtƒ±ysa, bu otomatik atlamayƒ± engellemek i√ßin hash'i kaldƒ±r.
  // Ayrƒ±ca sayfa ba≈üƒ±na (0,0) kaydƒ±r.
  (function(){
    // hemen √ßalƒ±≈ütƒ±r
    if(window.location.hash){
      // replaceState ile hash'i kaldƒ±r (geri butonu davranƒ±≈üƒ±nƒ± bozmadan)
      history.replaceState(null, document.title, window.location.pathname + window.location.search);
      // kesin scroll top
      try { window.scrollTo(0,0); } catch(e){}
      // eski tarayƒ±cƒ±larda dosya hazƒ±r olunca da tekrar kontrol
      window.addEventListener('DOMContentLoaded', () => { try { window.scrollTo(0,0); } catch(e){} });
    }
  })();
</script>

<header>
  <div class="container nav">
    <a href="#" class="brand"><img src="images/logo.png" alt="TRS Logo"><span>G√ºvenli Gelecek</span></a>
    <nav>
      <a href="#hero">Ana Sayfa</a>
      <a href="#urunler">√úr√ºnler</a>
      <a href="#hakkimizda">Hakkƒ±mƒ±zda</a>
      <a href="#iletisim">ƒ∞leti≈üim</a>
      <a class="cta" href="#" id="teklifBtn">Teklif Al</a>
    </nav>
  </div>
</header>

<!-- (Hero / diƒüer b√∂l√ºmler burada olabilir; senin mevcut sayfanƒ±n diƒüer i√ßeriklerini koru) -->
<section id="hero" style="height:420px; display:grid; place-items:center; text-align:center;">
  <div class="container">
    <h1 style="font-size:2rem;color:var(--gold)">TRS ‚Äî G√ºvenli Gelecek</h1>
    <p style="color:var(--muted)">Ana sayfa i√ßeriƒüi buraya gelecek. A≈üaƒüƒ±ya kaydƒ±rarak yorumlarƒ± g√∂rebilirsiniz.</p>
  </div>
</section>

<!-- √ñrnek diƒüer b√∂l√ºmler (urunler/hakkimizda/iletisim) - ger√ßek kodun buradaysa koru -->
<section id="urunler" style="padding:40px 0;">
  <div class="container"><h2 style="color:var(--text)">√úr√ºnler</h2></div>
</section>

<section id="hakkimizda" style="padding:40px 0;">
  <div class="container"><h2 style="color:var(--text)">Hakkƒ±mƒ±zda</h2></div>
</section>

<section id="iletisim" style="padding:40px 0;">
  <div class="container"><h2 style="color:var(--text)">ƒ∞leti≈üim</h2></div>
</section>

<!-- üí¨ YORUMLAR -->
<section class="comment-section" id="yorumlar">
  <div class="container">
    <h2>üí¨ Yorumlar</h2>
    <form class="comment-form" id="commentForm">
      <input type="text" id="fullName" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z (√∂r: Ahmet Yƒ±lmaz)" required>
      <select id="rating" required>
        <option value="" disabled selected>Puan verin</option>
        <option value="1">1 ‚Äî ‚≠ê</option>
        <option value="2">2 ‚Äî ‚≠ê‚≠ê</option>
        <option value="3">3 ‚Äî ‚≠ê‚≠ê‚≠ê</option>
        <option value="4">4 ‚Äî ‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="5">5 ‚Äî ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
      </select>
      <textarea id="message" placeholder="Yorumunuz..." required rows="5"></textarea>
      <button type="submit">G√∂nder</button>
    </form>

    <div class="comment-controls">
      <label for="sortSelect">Sƒ±rala: </label>
      <select id="sortSelect">
        <option value="timestamp_desc">En Yeni</option>
        <option value="timestamp_asc">En Eski</option>
        <option value="rating_desc">En Y√ºksek Puan</option>
        <option value="rating_asc">En D√º≈ü√ºk Puan</option>
      </select>
    </div>

    <div class="comment-list" id="commentList"></div>
    <div class="pagination" id="pagination"></div>
  </div>
</section>

<div class="notify-overlay" id="notifyOverlay" aria-hidden="true">
  <div class="notify" id="notifyBox">
    <div class="close" id="notifyClose">√ó</div>
    <div class="icon-wrap">
      <div class="ring" id="ringAnim" style="display:none"></div>
      <div class="icon" id="notifyIcon">‚úì</div>
    </div>
    <div class="text" id="notifyText">Ba≈üarƒ±yla g√∂nderildi.</div>
    <div class="reason" id="notifyReason" style="display:none"></div>
  </div>
</div>

<!-- Silme onay modal -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3>Bu yorumu silmek istediƒüinize emin misiniz?</h3>
    <button class="accept" id="confirmAccept">Kabul Ediyorum</button>
    <button class="cancel" id="confirmCancel">Vazge√ßiyorum</button>
  </div>
</div>

<div class="popup-overlay" id="popup">
  <div class="popup">
    <span class="close-btn" id="closePopup">√ó</span>
    <h3>ƒ∞leti≈üim Se√ßiniz</h3>
    <a href="#" id="phoneOption">üìû Telefonla Ara / WhatsApp</a>
    <a href="#" id="gmailOption">üìß E-Posta G√∂nder</a>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // Firestore yapƒ±landƒ±rman (senin verdiƒüin)
  const firebaseConfig = {
    apiKey: "AIzaSyAyA9Wb5eETRMUFzpqPSWX4d-o9SjYZClk",
    authDomain: "trs-yorumlar.firebaseapp.com",
    projectId: "trs-yorumlar",
    storageBucket: "trs-yorumlar.appspot.com",
    messagingSenderId: "587642499585",
    appId: "1:587642499585:web:5d07f7912249a77fdf8600"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Bildirim/uyarƒ± elemanlarƒ±
  const notifyOverlay=document.getElementById('notifyOverlay'),
        notifyBox=document.getElementById('notifyBox'),
        notifyIcon=document.getElementById('notifyIcon'),
        notifyText=document.getElementById('notifyText'),
        notifyReason=document.getElementById('notifyReason'),
        ringAnim=document.getElementById('ringAnim'),
        notifyClose=document.getElementById('notifyClose');

  function showNotify({type='success',title='',reason=''}){
    notifyBox.classList.remove('success','error');
    notifyBox.classList.add(type);
    if(type==='success'){
      notifyIcon.textContent='‚úì'; notifyText.textContent=title||'Yorum ba≈üarƒ±yla eklendi.'; notifyReason.style.display='none';
    } else {
      notifyIcon.textContent='‚úï'; notifyText.textContent=title||'Yorum g√∂nderilemedi.'; notifyReason.style.display='block'; notifyReason.textContent=reason||'';
    }
    ringAnim.style.display='block'; notifyOverlay.style.display='flex'; notifyOverlay.setAttribute('aria-hidden','false');
    setTimeout(()=>{ ringAnim.style.display='none'; },1600);
  }
  notifyClose.onclick = ()=> { notifyOverlay.style.display='none'; notifyOverlay.setAttribute('aria-hidden','true'); };

  // K√ºf√ºr filtresi ve yardƒ±mcƒ± fonksiyonlar
  const BAD_WORDS=['siktir','orospu','pi√ß','amcƒ±k','yarak','g√∂t','fuck','shit','bitch'];
  const escapeHtml=str=>String(str||'').replace(/[&<>"'\/]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;'}[s]));
  const maskName=n=>{ if(!n) return ''; const p=n.split(' '); return p.map(x=> (x && x[0]) ? x[0].toUpperCase()+'*'.repeat(Math.max(3,x.length-1)) : '' ).join(' '); }
  const containsBadWord = t => { if(!t) return false; const s=t.toLowerCase(); return BAD_WORDS.some(w=> new RegExp('\\b'+w.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'\\b','i').test(s)); };

  // DOM elemanlarƒ± ve state
  const commentForm=document.getElementById('commentForm'),
        commentList=document.getElementById('commentList'),
        pagination=document.getElementById('pagination'),
        sortSelect=document.getElementById('sortSelect'),
        confirmOverlay=document.getElementById('confirmOverlay'),
        confirmAccept=document.getElementById('confirmAccept'),
        confirmCancel=document.getElementById('confirmCancel'),
        popup=document.getElementById('popup'),
        teklifBtn=document.getElementById('teklifBtn'),
        closePopup=document.getElementById('closePopup'),
        phoneOption=document.getElementById('phoneOption'),
        gmailOption=document.getElementById('gmailOption');

  let commentsData=[], currentPage=1, perPage=10, deleteTargetId=null;
  const currentUser='demoUser'; // ger√ßek kullanƒ±mda auth uid ile deƒüi≈ütir

  // Popup teklif al
  teklifBtn && teklifBtn.addEventListener('click', e=>{ e.preventDefault(); popup.style.display='flex'; document.body.style.overflow='hidden'; });
  closePopup && closePopup.addEventListener('click', ()=>{ popup.style.display='none'; document.body.style.overflow='auto'; });
  popup && popup.addEventListener('click', e=>{ if(e.target===popup){ popup.style.display='none'; document.body.style.overflow='auto'; }});
  function isMobileDevice(){ return /Mobi|Android|iPhone|iPad|IEMobile|Opera Mini/i.test(navigator.userAgent); }
  const businessPhone = "+905510979299";
  const whatsappNumber = "905510979299";
  const whatsappPrefill = encodeURIComponent("Merhaba TRS, teklif almak istiyorum. (Site √ºzerinden geldim.)");
  phoneOption && phoneOption.addEventListener('click', e=>{ e.preventDefault(); if(isMobileDevice()){ window.location.href = "tel:" + businessPhone; } else { window.open("https://web.whatsapp.com/send?phone="+whatsappNumber+"&text="+whatsappPrefill,"_blank"); } popup.style.display='none'; document.body.style.overflow='auto'; });
  const gmailLink = "https://mail.google.com/mail/?view=cm&fs=1&to=trsturkeyofficial@gmail.com&su=Teklif%20Talebi&body=Merhaba%20TRS,%20bir%20teklif%20almak%20istiyorum.";
  gmailOption && gmailOption.addEventListener('click', e=>{ e.preventDefault(); window.open(gmailLink,"_blank"); popup.style.display='none'; document.body.style.overflow='auto'; });

  // Render / pagination
  function renderComments(){
    commentList.innerHTML='';
    const start=(currentPage-1)*perPage;
    const pageData=commentsData.slice(start,start+perPage);
    pageData.forEach(d=>{
      const item=document.createElement('div');
      item.className='comment-item';
      const isOwner = (d.userId === currentUser) || (d.userId === 'admin');
      const avatarChar = escapeHtml((maskName(d.fullName)||'').charAt(0) || '');
      item.innerHTML = `
        <div class="meta">
          <div class="avatar">${avatarChar}</div>
          <div>
            <div class="name">${escapeHtml(maskName(d.fullName))}</div>
            <div class="rating">${'‚≠ê'.repeat(d.rating || 0)}</div>
          </div>
        </div>
        <p>${escapeHtml(d.message)}</p>
        ${isOwner ? '<button class="delete-btn">Sil</button>' : ''}
      `;
      if(isOwner){
        const delBtn = item.querySelector('.delete-btn');
        delBtn.addEventListener('click', ()=>{ deleteTargetId = d.id; confirmOverlay.style.display='flex'; });
      }
      commentList.appendChild(item);
    });
    renderPagination();
  }

  function renderPagination(){
    pagination.innerHTML='';
    const totalPages = Math.max(1, Math.ceil(commentsData.length / perPage));
    for(let i=1;i<=totalPages;i++){
      const btn = document.createElement('button');
      btn.textContent = i;
      if(i===currentPage) btn.classList.add('active');
      btn.addEventListener('click', ()=> { currentPage = i; renderComments(); window.scrollTo({top: document.querySelector('#yorumlar').offsetTop - 20, behavior:'smooth'}); });
      pagination.appendChild(btn);
    }
  }

  // Firestore realtime fetch + sorting
  function fetchComments(){
    // se√ßime g√∂re sorgu hazƒ±rlanƒ±yor
    let orderField = 'timestamp';
    let dir = 'desc';
    const val = sortSelect.value;
    if(val === 'rating_desc'){ orderField = 'rating'; dir = 'desc'; }
    else if(val === 'rating_asc'){ orderField = 'rating'; dir = 'asc'; }
    else if(val === 'timestamp_asc'){ orderField = 'timestamp'; dir = 'asc'; }

    // onSnapshot ile realtime dinleme
    try {
      db.collection('comments').orderBy(orderField, dir).onSnapshot(snap => {
        commentsData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        currentPage = 1; // sƒ±ralama deƒüi≈üince sayfayƒ± 1'e al (isteƒüe g√∂re deƒüi≈ütirilebilir)
        renderComments();
      }, err => {
        console.error('Firestore snapshot error:', err);
        // hata durumunda commentsData'yƒ± temizlemeyiz; kullanƒ±cƒ±ya g√∂sterilebilir hata yapabilirsin
      });
    } catch(e){
      console.error('fetchComments error', e);
    }
  }
  sortSelect && (sortSelect.onchange = ()=> { fetchComments(); });

  // Ba≈ülat
  fetchComments();

  // Form g√∂nderimi
  commentForm && (commentForm.onsubmit = async e => {
    e.preventDefault();
    const fullName = (document.getElementById('fullName').value || '').trim();
    const rating = parseInt(document.getElementById('rating').value || '0', 10);
    const message = (document.getElementById('message').value || '').trim();

    if(!fullName || !rating || !message){
      showNotify({type:'error', title:'Eksik bilgi', reason:'T√ºm alanlarƒ± doldurun.'});
      return;
    }
    if(containsBadWord(message) || containsBadWord(fullName)){
      showNotify({type:'error', title:'Yorum reddedildi', reason:'Uygunsuz kelimeler tespit edildi.'});
      return;
    }

    try{
      await db.collection('comments').add({
        fullName,
        rating,
        message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        userId: currentUser
      });
      showNotify({type:'success', title:'Te≈üekk√ºrler! Yorum eklendi.'});
      commentForm.reset();
      // onSnapshot otomatik g√ºncelleyecek
    } catch(err){
      console.error('add comment error', err);
      showNotify({type:'error', title:'Hata', reason:'Yorum eklenemedi.'});
    }
  });

  // Silme onayƒ±
  confirmAccept && (confirmAccept.onclick = async () => {
    if(!deleteTargetId) { confirmOverlay.style.display='none'; return; }
    try{
      await db.collection('comments').doc(deleteTargetId).delete();
      confirmOverlay.style.display='none';
      deleteTargetId = null;
    } catch(err){
      console.error('delete error', err);
      showNotify({type:'error', title:'Hata', reason:'Yorum silinemedi.'});
    }
  });
  confirmCancel && (confirmCancel.onclick = () => { confirmOverlay.style.display='none'; deleteTargetId = null; });

  // Sayfa a√ßƒ±ldƒ±ƒüƒ±nda: eƒüer URL hash yoksa hero g√∂r√ºn√ºr (ilk script zaten hash'ƒ± temizledi).
  // Eƒüer kullanƒ±cƒ± doƒürudan #yorumlar ile gelmi≈ü olursa tarayƒ±cƒ± eski davranƒ±≈üƒ±ndan dolayƒ± atlamƒ±≈ü olabilir, ama biz hash'i kaldƒ±rdƒ±k.

  // G√ºvenlik: onSnapshot √ßalƒ±≈ümƒ±yorsa konsola bak. Eƒüer sayfan "ana sayfa g√∂r√ºnm√ºyor" diyorsan:
  // - Netlify/hosting tarafƒ±nda y√∂nlendirme/hash yok mu kontrol et.
  // - Konsolda hata varsa bana ilet (API key/Firestore rules vb.).

</script>
</body>
</html>
